import hashlib
import requests
import time
import os
import argparse
from typing import List
from rich import print
from rich.console import Console

# === CONFIGURATION ===
# The model can be specified via command-line argument.
# See a list of models at https://openrouter.ai/models
DEFAULT_MODEL = "x-ai/grok-3-beta"
OPENROUTER_API_URL = "https://openrouter.ai/api/v1/chat/completions"
THINK_DEPTH = 888888

console = Console()

# === TRADITIONAL CHINESE WORD LIST ===
words = [
    '的', '我', '你', '是', '了', '不', '他', '我們', '在', '有', '她', '們', '這', '那', '個', '人', '家', '學校',
    '朋友', '中國', '台灣', '水', '茶', '食物', '來', '去', '說', '看', '吃', '喝', '做', '想', '要', '會', '喜歡',
    '好', '大', '小', '多', '少', '很', '都', '嗎', '什麼', '誰', '哪裡', '哪兒', '為什麼', '多少', '男人', '女人',
    '孩子', '爸爸', '媽媽', '學生', '老師', '這裡', '那裡', '上面', '下面', '裡面', '外面', '前面', '後面', '商店',
    '香港', '今天', '明天', '昨天', '現在', '早上', '下午', '晚上', '年', '月', '日', '時間', '飯', '菜', '水果',
    '肉', '東西', '錢', '書', '電腦', '手機', '桌子', '椅子', '車', '買', '賣', '寫', '讀', '走', '跑', '坐', '站',
    '開', '關', '給', '拿', '找', '等', '問', '回答', '愛', '知道', '覺得', '希望', '不好', '高', '矮', '長', '短',
    '新', '舊', '老', '漂亮', '帥', '可愛', '好吃', '難吃', '高興', '難過', '累', '忙', '快', '慢', '貴', '便宜',
    '太', '也', '沒', '常常', '最', '就', '才', '本', '張', '杯', '瓶', '碗', '件', '條', '輛', '隻', '呢', '吧',
    '過', '和', '跟', '但是', '因為', '所以', '如果', '還是', '或者', '喂', '啊', '哎呀', '哦', '一', '及', '與',
    '以', '種', '能', '著', '但', '還', '可以', '自己', '為', '所', '他們', '兩', '各', '可', '或', '又', '將',
    '於', '由', '從', '更', '被', '已', '者', '每', '次', '把', '三', '問題', '其', '讓', '此', '再', '只', '則',
    '卻', '並', '位', '表示', '到', '公司', '社會', '天', '因此', '它', '中', '使', '工作', '全', '使用', '這些',
    '裡', '由於', '時候', '這樣', '認為', '事', '向', '可能', '美國', '幾', '系統', '政府', '大家', '國家', '許多',
    '生活', '已經', '大學', '研究', '因', '二', '活動', '該', '世界', '應', '四', '方式', '內', '項', '下', '環境',
    '一些', '必須', '文化', '沒有', '不能', '如', '開始', '元', '不同', '仍', '網路', '日本', '用', '中心', '雖然',
    '重要', '地方', '關係', '市場', '提供', '應該', '指出', '經濟', '發展', '教育', '成為', '非常', '便', '方面',
    '很多', '然後', '未', '發現', '一樣', '而且', '心', '不過', '無法', '企業', '正', '服務', '較', '不會', '臺灣',
    '曾', '空間', '看到', '五', '如何', '國內', '無', '對於', '以及', '之後', '可是', '當', '人員', '比', '先',
    '產品', '資訊', '資料', '比較', '先生', '地', '除了', '大陸', '需要', '像', '歲', '請', '些', '名', '另', '若',
    '亦', '地區', '技術', '至', '特別', '其實', '國際', '不要', '發生', '參加', '一定', '其中', '台北', '包括',
    '講', '造成', '常', '即', '出現', '政治', '話', '單位', '一直', '是否', '當然', '整', '處理', '歷史', '了解',
    '怎麼', '機會', '聽', '所有', '只要', '令', '甚至', '真', '六', '呀', '情況', '錢', '方法', '點', '任何', '經驗',
    '藝術', '你們', '十', '主要', '增加', '提出', '您', '計畫', '作', '利用', '之間', '成長', '能夠', '決定', '學習',
    '誰', '見', '半', '時代', '完成', '帶', '相當', '同學', '能力', '別人', '生命', '場', '會議', '容易', '開發',
    '民眾', '事情', '事實', '有關', '自', '組織', '言', '建立', '相關', '均', '產生', '業者', '解決', '完全', '的話',
    '接受', '知', '約', '一般', '推動', '過程', '管理', '功能', '手', '打', '要求', '小朋友', '教授', '難', '我國',
    '告訴', '內容', '結果', '調查', '家庭', '成立', '選擇', '經營', '然而', '父母', '人類', '至於', '尤其', '配合',
    '進入', '例如', '得', '討論', '依', '作品', '情形', '資源', '原因', '啦', '妳', '運動', '觀念', '軟體', '品質',
    '經過', '如此', '嗯', '精神', '影響', '之', '好像', '成', '參與', '以後', '於是', '部分', '另外', '公園', '透過',
    '訓練', '努力', '具有', '共同', '所謂', '行為', '合作', '經', '目標', '起來', '考慮', '意見', '辦法', '音樂',
    '連', '受', '廠商', '受到', '一切', '或是', '中央', '某', '女性', '教學', '極', '獲得', '真的', '路', '國小',
    '部份', '工程', '女人', '舉行', '句', '只是', '段', '根據', '現象', '人民', '土地', '面對', '注意', '新聞',
    '繼續', '相信', '政策', '變成', '計劃', '強調', '學', '人士', '前', '存在', '制度', '意義', '代表', '課程',
    '需求', '人生', '那些', '成功', '產業', '負責', '民間', '雖', '直接', '幾乎', '分', '實際', '團體', '價值',
    '使得', '類', '形成', '科技', '這麼', '七', '不但', '往', '本身', '標準', '似乎', '應用', '動物', '電話', '態度',
    '建設', '事業', '那麼', '字', '舉辦', '自我', '有的', '具', '目的', '塊', '條件', '即使', '十分', '放', '電影',
    '科學', '執行', '邊', '委員會', '溝通', '一起', '針對', '員工', '引起', '自然', '安全', '總統', '此外', '擁有',
    '並且', '事件', '研究所', '語言', '嚴重', '故事', '學術', '片', '設備', '之外', '基本', '實在', '久', '套',
    '達到', '改善', '死', '結構', '住', '皆', '改變', '小組', '支持', '座', '醫院', '既', '僅', '值得', '學者',
    '八', '交通', '階段', '就是', '申請', '主管', '同', '感覺', '電視', '母親', '嘛', '記者', '壓力', '快樂', '敢',
    '院', '也許', '人們', '談', '生產', '怕', '身體', '規定', '程度', '積極', '知識', '作為', '機構', '而是', '鼓勵',
    '角色', '狀況', '專家', '據', '清楚', '不僅', '比賽', '玩', '效果', '越', '保護', '共', '開放', '附近', '父親',
    '專業', '經費', '曾經', '願意', '分別', '重視', '不少', '歡迎', '小孩', '小時', '中國人', '顯示', '中共', '出',
    '避免', '屬於', '實施', '聲音', '主義', '行動', '不可', '只有', '校園', '興趣', '山', '表現', '回來', '主任',
    '經常', '不再', '電子', '思想', '頭', '終於', '謝謝', '協助', '除', '當地', '正式', '低', '性', '份', '因素',
    '推出', '價格', '認識', '方向', '責任', '說明', '工業', '大量', '逐漸', '心理', '一點', '供', '須', '簡單', '運用',
    '觀察', '往往', '規劃', '減少', '重新', '業務', '報導', '仍然', '感到', '領域', '有效', '女', '從事', '發揮',
    '人才', '反而', '行政', '銀行', '公共', '媒體', '提高', '代', '社區', '力量', '教育部', '愈', '超過', '維持',
    '家長', '結合', '校長', '通常', '缺乏', '委員', '特色', '有時', '教師', '之前', '遠', '控制', '否則', '法',
    '少數', '原則', '臉', '通過', '建議', '工具', '作業', '達', '節目', '智慧', '來自', '變化', '同樣', '形式', '站',
    '以為', '健康', '擔任', '人口', '剛', '特殊', '原來', '道', '傳統', '總是', '前往', '投資', '加強', '不斷',
    '對象', '追求', '加上', '思考', '製作', '台北市', '取得', '出來', '加入', '台', '安排', '兒童', '國中', '範圍',
    '老人', '雙方', '牠', '北京', '年輕', '結束', '教', '程式', '婦女', '找到', '彼此', '全球', '成本', '回到', '部',
    '而已', '之下', '變', '期間', '非', '小姐', '整體', '採用', '根本', '叫', '歐洲', '正在', '加以', '充滿', '系列',
    '隨著', '早', '等等', '頗', '不足', '總', '分析', '深', '報告', '不錯', '在於', '旁', '笑', '故', '消費者', '意識',
    '公尺', '民族', '為主', '大眾', '到底', '願', '度', '大概', '對方', '官員', '發表', '進一步', '正確', '豐富',
    '國民黨', '戰爭', '怎麼樣', '只好', '明顯', '改革', '表達', '肯定', '強', '哪', '樹', '適合', '別', '國外', '關心',
    '蘇聯', '成績', '人物', '聽到', '創造', '不必', '不論', '尚', '居民', '不管', '美麗', '伊拉克', '帶來', '般',
    '永遠', '感情', '兒子', '這樣子', '起', '全部', '回家', '獨立', '英國', '理論', '面臨', '選手', '分鐘', '內部',
    '西方', '人家', '準備', '眼睛', '眼', '離開', '競爭', '專利', '成果', '活', '心情', '介紹', '現場', '突然',
    '客戶', '間', '印象', '花', '海', '保持', '時期', '層', '方便', '幫助', '基礎', '個人', '新竹', '李', '生',
    '圖書館', '她們', '美元', '以來', '或許', '課', '病人', '實驗', '有時候', '辦理', '部門', '類似', '廣告', '送',
    '夠', '新加坡', '擔心', '商業', '掌握', '兩岸', '門', '方案', '至少', '看法', '原本', '措施', '社團', '九',
    '展開', '博士', '道路', '竟', '項目', '需', '學院', '同意', '原住民', '策略', '白', '平均', '靠', '互相', '地位',
    '體育', '樣', '亞洲', '採取', '畢業', '相同', '欣賞', '法律', '詞', '大型', '中華', '台大', '意思', '在一起',
    '係', '持續', '群', '慢慢', '高雄', '製造', '醫療', '邀請', '滿足', '速度', '重點', '保存', '評估', '限制',
    '符合', '利益', '組成', '檢查', '看見', '瞭解', '立刻', '女兒', '數', '上課', '整合', '更多', '唯一', '人數',
    '的確', '主題', '用戶', '快速', '設施', '文學', '步', '美', '失去', '做為', '複雜', '屆', '作用', '調整', '佔',
    '高中', '動作', '模式', '吸引', '記得', '例', '推廣', '本來', '具體', '太太', '之中', '宗教', '反應', '觀眾',
    '立場', '旅遊', '因而', '理念', '它們', '回', '支', '少年', '輔導', '爭取', '想到', '尊重', '替', '地點', '何',
    '黨', '進步', '欲', '危機', '正常', '角度', '尚未', '院長', '習慣', '期', '環保', '交流', '困難', '完整', '費用',
    '上述', '呈現', '照顧', '達成', '批', '培養', '垃圾', '圖', '擴大', '篇', '比例', '風格', '難以', '機關', '情緒',
    '勞工', '一旦', '多媒體', '求', '絕對', '資料庫', '選舉', '不可能', '馬上', '說話', '享受', '工廠', '消息', '番',
    '趨勢', '房子', '觀點', '購買', '普遍', '設立', '差異', '差', '統一', '青年', '行政院', '規模', '股', '破壞',
    '想要', '換', '選', '人力', '水準', '首', '河川', '文字', '立即', '適當', '醫師', '屬', '重', '就是說', '結婚',
    '日子', '貿易', '參觀', '公開', '順利', '男', '銷售', '辦', '維護', '投入', '稱', '民進黨', '必', '有限', '預算',
    '計算', '效率', '樣子', '訪問', '位於', '接觸', '流行', '喔', '股市', '召開', '運作', '出版', '藉', '觀光',
    '降低', '大約', '來源', '理由', '回答', '青少年', '基本', '看看', '合理', '採', '生物', '中華民國', '直到', '氣',
    '給予', '中文', '法國', '答案', '金融', '週', '農民', '法令', '訊息', '公里', '剛剛', '紅', '聲', '倍', '加',
    '民主', '臺北', '無論', '辦公室', '一方面', '良好', '級', '遊戲', '酒', '形象', '導致', '提到', '氣氛', '動',
    '院士', '指', '充分', '現代', '必要', '生態', '汽車', '例子', '有點', '博物館', '權力', '族群', '媽', '牆',
    '船', '基金會', '詩', '雜誌', '生存', '且', '小孩子', '大樓', '最好', '讀書', '見到', '最佳', '出去', '想法',
    '幫', '醫生', '堅持', '創作', '廣場', '成員', '留下', '森林', '算', '顆', '各', '男女', '特性', '影像', '遭',
    '強烈', '欸', '解釋', '儘管', '主動', '演出', '文章', '理想', '重大', '腳', '危險', '背景', '唱', '即將', '大部分',
    '通訊', '越來越', '考試', '學期', '反', '心靈', '獲', '既然', '設', '顧客', '家人', '組', '紛紛', '提升', '搞',
    '隨時', '譬如', '子女', '確定', '公平', '視為', '技巧', '接著', '畫', '領導', '小心', '主辦', '探討', '赴',
    '回去', '弟弟', '風', '小學', '興建', '狀態', '支援', '治療', '衣服', '名字', '參考', '女孩', '男性', '教室',
    '太陽', '口', '陳', '稱為', '國民', '研討會', '飛機', '建築師', '王', '究竟', '確實', '公路', '至今', '天下',
    '考量', '管', '判斷', '扮演', '相對', '校方', '早已', '讀者', '大會', '工人', '數量', '材料', '特徵', '殺',
    '算是', '革命', '國人', '魚', '操作', '統計', '德國', '顯然', '信心', '放棄', '懂', '建', '一生', '黑', '小說',
    '主席', '政大', '集團', '報名', '著名', '道德', '消失', '經由', '遇到', '提', '心態', '集中', '建築物', '畫面',
    '定', '甚', '可惜', '醫學', '輸入', '百', '型態', '道理', '愈來愈', '色彩', '歌', '現實', '婚姻', '地球', '指導',
    '架構', '進口', '論文', '出國', '商品', '市長', '分為', '夢', '以前', '恐怕', '死亡', '哥哥', '檔案', '滿意',
    '滿', '休閒', '有趣', '職業', '說法', '英文', '緊張', '預計', '兄弟', '體系', '專案', '孔子', '報導', '一半',
    '疾病', '其它', '外國', '牠們', '報紙', '狗', '協調', '念', '哲學', '碰到', '提昇', '關於', '同仁', '深入', '漫畫',
    '資金', '想像', '短', '即可', '西', '相', '位置', '錯', '穩定', '尋找', '鳥', '系', '如此', '長大', '促進', '人文',
    '衝突', '廚房', '海外', '表演', '再度', '電信', '反映', '北', '筆', '近', '障礙', '焦點', '忽然', '到處', '植物',
    '顯得', '不一定', '攝影', '隨', '概念', '面積', '為何', '高達', '關鍵', '作法', '來到', '胡適', '倒', '人人',
    '仔細', '原', '成就', '視', '行銷', '好幾', '辛苦', '年輕人', '信', '漸漸', '教材', '動詞', '整理', '男生',
    '遊客', '女生', '懷疑', '痛苦', '交換', '互動', '設置', '留', '居住', '因應', '丈夫', '紀錄', '答', '畫家',
    '數字', '一向', '連線', '以免', '固定', '通信', '恢復', '修正', '景觀', '線', '縣市', '他人', '基於', '實現',
    '演講', '男子', '具備', '奇怪', '空氣', '會員', '取', '深刻', '相互', '多數', '總經理', '收', '權利', '照片',
    '病', '物質', '宿舍', '教練', '宇宙', '更加', '住宅', '明白', '竟然', '光', '迅速', '睡', '大多數', '不良',
    '自動', '哦', '突破', '污染', '陸續', '飛', '內心', '女子', '玻璃', '神', '市民', '承認', '不滿', '年齡', '記憶',
    '打算', '老闆', '成熟', '進', '證明', '國立', '施工', '叫做', '入', '包含', '場所', '後', '行', '休息', '從來',
    '東', '要是', '適應', '工會', '聽說', '高級', '距離', '不易', '有沒有', '人性', '走到', '拍', '馬', '規則',
    '以外', '關懷', '另一方面', '實力', '假如', '研發', '攻擊', '幹部', '資格', '引進', '做到', '吃飯', '保險', '發行',
    '壞', '證券', '大幅', '還有', '公斤', '性質', '某些', '幸福', '以上', '明確', '聯盟', '主持', '一再', '保育',
    '師生', '立委', '改', '多半', '管道', '絕不', '報', '認同', '一致', '最多', '股票', '作者', '島', '細胞', '病毒',
    '衛生', '易', '抗議', '免費', '教育局', '農業', '管制', '自動化', '展示', '情感', '熱', '一邊', '忘', '拒絕',
    '妻子', '行業', '經理', '那樣', '和平', '哭', '城', '根', '主人', '廠', '大人', '機器', '不得', '橋', '以下', '幅',
    '公分', '失敗', '真實', '主張', '車子', '星期', '表面', '紐約', '做法', '創意', '台中', '乃', '構成', '網際',
    '怎麼辦', '事務', '眼前', '警察', '個性', '研究院', '意願', '視訊', '體制', '經濟部', '感受', '負責人', '陽光'
]
DECK_SIZE = len(words)

# === HASH FUNCTION ===
def hash_question(question: str, salt: str = "", times: int = THINK_DEPTH) -> int:
    h = (question + salt).encode()
    for _ in range(times):
        h = hashlib.sha512(h).digest()
    return int.from_bytes(h, 'big')

# === DRAWING WORDS ===
def draw_words(question: str, count: int) -> List[str]:
    drawn = []
    used_indices = set()
    timestamp = int(time.time())  # Add a bit of time-based randomness

    for i in range(count):
        salt = f"{question}-word{i}-time{timestamp}"
        while True:
            index = hash_question(question, salt) % DECK_SIZE
            if index not in used_indices:
                used_indices.add(index)
                drawn.append(words[index])
                break
    return drawn

# === INTERPRETATION REQUEST ===
def interpret_reading(question: str, word_list: List[str], model: str) -> str:
    api_key = os.getenv("OPENROUTER_API_KEY")
    if not api_key:
        return (
            "[red]❌ OPENROUTER_API_KEY environment variable not set.[/red]\n"
            "[yellow]💡 Tip: Get a key from https://openrouter.ai and set it.[/yellow]\n"
            "   Linux/macOS: export OPENROUTER_API_KEY='your-key-here'\n"
            "   Windows: setx OPENROUTER_API_KEY your-key-here"
        )

    word_text = ", ".join(word_list)

    system_prompt = (
        "You are a wise sage. Interpret the drawn Traditional Chinese words in a poetic and insightful way, "
        "connecting them to the user's question. Provide a simple, clear, and helpful message."
    )
    user_prompt = (
        f"The question is: '{question}'\n\n"
        f"The following Traditional Chinese word(s) were drawn:\n{word_text}"
    )

    payload = {
        "model": model,
        "messages": [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt},
        ],
    }
    headers = {
        "Authorization": f"Bearer {api_key}",
        "Content-Type": "application/json",
        "HTTP-Referer": "https://github.com/reden/tcp",
        "X-Title": "Chinese Oracle",
    }


    console.print("\n[bold blue]Consulting the digital ether...[/bold blue]")

    try:
        console.print("\n[bold blue]Sending request to OpenRouter...[/bold blue]")
        response = requests.post(OPENROUTER_API_URL, headers=headers, json=payload, timeout=300)
        console.print("[bold blue]Received response from OpenRouter.[/bold blue]")
        response.raise_for_status()
        result = response.json()
        return result.get("choices", [{}])[0].get("message", {}).get("content", "No response from LLM.")
    except requests.exceptions.HTTPError as e:
        return f"[red]An HTTP error occurred with the OpenRouter API:[/red] {e.response.text}"
    except requests.exceptions.ConnectionError:
        return "[red]❌ Unable to connect to OpenRouter. Check your internet connection.[/red]"
    except Exception as e:
        return f"[red]An unexpected error occurred:[/red] {e}"

# === MAIN LOGIC ===
def main():
    parser = argparse.ArgumentParser(
        description="Get a Traditional Chinese reading using an LLM via OpenRouter.",
        formatter_class=argparse.RawTextHelpFormatter
    )
    parser.add_argument(
        "--model",
        type=str,
        default=DEFAULT_MODEL,
        help=f"The model to use from OpenRouter.\nExample: 'mistralai/mistral-7b-instruct'\nDefault: '{DEFAULT_MODEL}'"
    )
    args = parser.parse_args()
    model_name = args.model

    console.print("[bold cyan]Traditional Chinese Oracle[/bold cyan] (via OpenRouter)")
    console.print(f"[dim]Using model: {model_name}[/dim]")
    question = console.input("[bold yellow]Ask your question[/bold yellow]: ")

    try:
        word_count = int(console.input("How many words to draw? (1-10): ").strip())
        if not 1 <= word_count <= 10:
            word_count = 3
    except ValueError:
        word_count = 3

    drawn_words = draw_words(question, word_count)

    console.print(f"\n[bold magenta]Your Word{'s' if word_count > 1 else ''}:[/bold magenta]")
    for i, word in enumerate(drawn_words):
        console.print(f"[bold]{i+1}. {word}[/bold]")

    interpretation = interpret_reading(question, drawn_words, model_name)
    console.print(f"\n[italic green]{interpretation}[/italic green]\n")

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        console.print("\n[bold red]⏹️ Reading canceled.[/bold red]")
